name: Auto Sign Verification Record

on:
  schedule:
    - cron: "0 0 * * FRI"      # Every Friday 00:00 UTC
  workflow_dispatch:            # Allow manual runs

permissions:
  contents: write    # Allow this workflow to push changes back to the repo

jobs:
  sign:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq openssh-client openssl xxd

      - name: Install SSH private key (PKCS#8 PEM)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.POHW_SIGNING_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_signer.pem
          chmod 600 ~/.ssh/id_signer.pem
          ssh-keygen -y -f ~/.ssh/id_signer.pem > ~/.ssh/id_signer.pub || true

      - name: Debug PEM key file
        run: |
          echo "== File info =="
          ls -l ~/.ssh/id_signer.pem || echo "File not found"
          echo "== First few lines =="
          head -5 ~/.ssh/id_signer.pem || true
          echo "== Hex dump of header =="
          xxd -l 64 ~/.ssh/id_signer.pem || true

      - name: Run signing script
        env:
          SIGNING_KEY_PATH: ~/.ssh/id_signer.pem
        run: bash sign.sh

      - name: Commit and push signed outputs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "PoHW Auto-Signer"
          git config --global user.email "auto@pohw"
          git add -A
          git commit -m "Auto-sign verification record ($(date -u +'%Y-%m-%d'))" || echo "No changes to commit"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} HEAD:${{ github.ref }}