name: Auto Sign Verification Record

on:
  schedule:
    - cron: "0 0 * * FRI"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sign:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (fetch full history so rebase works)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set git identity
        run: |
          git config --global user.name  "PoHW CI"
          git config --global user.email "auto-signer@users.noreply.github.com"

      - name: Ensure up-to-date before work
        run: |
          git fetch origin main
          git checkout main
          git pull --rebase origin main

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq openssh-client openssl xxd

      - name: Install signing key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.POHW_SIGNING_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_signer.pem
          chmod 600 ~/.ssh/id_signer.pem
          ssh-keygen -y -f ~/.ssh/id_signer.pem > ~/.ssh/id_signer.pub || true

      - name: Debug PEM
        run: |
          echo "== File info =="; ls -l ~/.ssh/id_signer.pem
          echo "== First 5 lines =="; head -5 ~/.ssh/id_signer.pem || true
          echo "== Hex dump =="; xxd -l 64 ~/.ssh/id_signer.pem || true

      - name: Run signing script
        env:
          SIGNING_KEY_PATH: ~/.ssh/id_signer.pem
        run: bash sign.sh

      - name: Rebase again in case something landed while signing
        run: |
          git pull --rebase origin main || true

      - name: Push results (token remote)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git remote remove origin || true
          git remote add origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          git add -A
          git commit -m "Auto-sign and update homepage hash ($(date -u +'%Y-%m-%dT%H:%M:%SZ'))" || echo "No changes to commit"
          # simple one-shot push
          git push origin HEAD:main || \
          (echo "push failed; rebasing once and retrying" && git pull --rebase origin main && git push origin HEAD:main)