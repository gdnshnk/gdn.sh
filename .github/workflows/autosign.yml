name: Auto Sign Verification Record

on:
  schedule:
    - cron: "0 0 * * FRI"   # Every Friday 00:00 UTC
  workflow_dispatch: {}      # Allow manual runs

jobs:
  sign:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq openssh-client

      - name: Install SSH private key for signing
        env:
          SSH_PRIVATE_KEY: ${{ secrets.POHW_SIGNING_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keygen -y -f ~/.ssh/id_ed25519 > ~/.ssh/id_ed25519.pub

      - name: Run signer
        run: bash sign.sh

      - name: Commit & push (if changed)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name  "PoHW Auto-Signer"
          git config user.email "auto@pohw"
          git add -A
          git commit -m "Auto-sign verification record ($(date -u +%Y-%m-%d))" || echo "No changes to commit"
          git push